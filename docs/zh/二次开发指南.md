# KrillinAI 二次开发指南

## 目录

- [开发环境准备](#开发环境准备)
- [项目架构概览](#项目架构概览)
- [核心概念](#核心概念)
- [常见开发场景](#常见开发场景)
- [开发规范](#开发规范)
- [调试技巧](#调试技巧)
- [常见问题](#常见问题)

## 开发环境准备

### 必需工具

1. **Go 语言环境**
   ```powershell
   # 检查 Go 版本（需要 1.22+）
   go version
   ```

2. **Git**
   ```powershell
   git --version
   ```

3. **IDE 推荐**
   - GoLand（推荐）
   - VS Code + Go 插件

### 克隆项目

```powershell
git clone https://github.com/KrillinAI/KrillinAI.git
cd KrillinAI
```

### 安装依赖

```powershell
# 下载所有依赖
go mod download

# 整理依赖
go mod tidy
```

### 配置文件

1. 复制配置文件模板：
   ```powershell
   Copy-Item config\config-example.toml config\config.toml
   ```

2. 编辑 `config/config.toml`，填入你的 API 密钥和配置

### 运行项目

**服务器版：**
```powershell
go run cmd/server/main.go
```

**桌面版：**
```powershell
go run cmd/desktop/main.go
```

## 项目架构概览

### 分层架构

```
用户请求
    ↓
Handler 层（处理 HTTP 请求）
    ↓
Service 层（业务逻辑）
    ↓
Package 层（第三方服务集成）
    ↓
外部服务（OpenAI、阿里云等）
```

### 核心模块

1. **cmd/** - 应用程序入口
2. **internal/** - 内部业务逻辑（不对外暴露）
3. **pkg/** - 可复用的公共包
4. **config/** - 配置管理
5. **static/** - 前端静态资源

### 关键接口

项目定义了三个核心接口（`internal/types/interface.go`）：

```go
// 聊天补全接口（用于翻译）
type ChatCompleter interface {
    ChatCompletion(query string) (string, error)
}

// 语音转文字接口
type Transcriber interface {
    Transcription(audioFile, language, wordDir string) (*TranscriptionData, error)
}

// 文字转语音接口
type Ttser interface {
    Text2Speech(text string, voice string, outputFile string) error
}
```

## 核心概念

### 1. 配置系统

配置文件采用 TOML 格式，分为五个主要部分：

- `[app]` - 应用程序配置
- `[server]` - 服务器配置
- `[llm]` - 大语言模型配置
- `[transcribe]` - 语音识别配置
- `[tts]` - 文字转语音配置

**配置加载流程：**
```go
config.LoadConfig()  // 加载配置文件
config.CheckConfig() // 验证配置
```

### 2. 任务处理流程

字幕任务的完整处理流程：

```
1. 接收任务请求 (Handler)
   ↓
2. 创建任务对象 (Service)
   ↓
3. 下载/获取视频文件
   ↓
4. 提取音频
   ↓
5. 语音识别（转文字）
   ↓
6. 字幕分割对齐
   ↓
7. 翻译字幕（可选）
   ↓
8. 生成配音（可选）
   ↓
9. 合成最终视频
   ↓
10. 返回结果
```

### 3. 服务提供者模式

项目使用提供者模式来支持多种服务：

**语音识别提供者：**
- `openai` - OpenAI Whisper API
- `fasterwhisper` - 本地 FasterWhisper
- `whisperkit` - macOS 专用
- `whispercpp` - 跨平台 C++ 实现
- `aliyun` - 阿里云语音识别

**TTS 提供者：**
- `openai` - OpenAI TTS
- `aliyun` - 阿里云 TTS

## 常见开发场景

### 场景 1：添加新的语音识别服务

假设要添加一个名为 `newwhisper` 的新服务。

#### 步骤 1：在 `pkg/` 下创建新包

```powershell
New-Item -ItemType Directory -Path pkg\newwhisper
```

创建 `pkg/newwhisper/transcription.go`：

```go
package newwhisper

import (
    "krillin-ai/internal/types"
)

type Client struct {
    // 客户端配置
}

func NewClient() *Client {
    return &Client{}
}

// 实现 Transcriber 接口
func (c *Client) Transcription(audioFile, language, wordDir string) (*types.TranscriptionData, error) {
    // 实现语音识别逻辑
    return &types.TranscriptionData{
        Text: "识别的文本",
        Segments: []types.Segment{
            // 分段信息
        },
    }, nil
}
```

#### 步骤 2：在配置中添加支持

编辑 `config/config.go`，添加配置结构：

```go
type Transcribe struct {
    Provider      string                 `toml:"provider"`
    // ... 其他字段
    NewWhisper    LocalModelConfig       `toml:"newwhisper"` // 新增
}
```

在 `validateConfig()` 函数中添加验证：

```go
case "newwhisper":
    if Conf.Transcribe.NewWhisper.Model == "" {
        return errors.New("newwhisper 需要配置模型")
    }
```

#### 步骤 3：在服务层集成

编辑 `internal/service/init.go`，在 `NewService()` 中添加：

```go
case "newwhisper":
    svc.Transcriber = newwhisper.NewClient()
```

#### 步骤 4：更新配置示例

编辑 `config/config-example.toml`：

```toml
[transcribe]
provider = "newwhisper"  # 可选值新增 newwhisper

[transcribe.newwhisper]
model = "large-v2"
```

### 场景 2：添加新的 API 接口

假设要添加一个获取任务统计信息的接口。

#### 步骤 1：定义 DTO

在 `internal/dto/` 下创建或编辑文件：

```go
// 请求
type GetTaskStatsReq struct {
    StartDate string `form:"start_date"`
    EndDate   string `form:"end_date"`
}

// 响应
type GetTaskStatsRes struct {
    TotalTasks     int `json:"total_tasks"`
    CompletedTasks int `json:"completed_tasks"`
    FailedTasks    int `json:"failed_tasks"`
}
```

#### 步骤 2：实现 Service 层逻辑

在 `internal/service/` 下创建新文件或添加方法：

```go
func (s Service) GetTaskStats(req dto.GetTaskStatsReq) (*dto.GetTaskStatsRes, error) {
    // 实现统计逻辑
    stats := &dto.GetTaskStatsRes{
        TotalTasks:     100,
        CompletedTasks: 80,
        FailedTasks:    5,
    }
    return stats, nil
}
```

#### 步骤 3：添加 Handler

在 `internal/handler/` 下添加处理函数：

```go
func (h Handler) GetTaskStats(c *gin.Context) {
    var req dto.GetTaskStatsReq
    if err := c.ShouldBindQuery(&req); err != nil {
        response.R(c, response.Response{
            Error: -1,
            Msg:   "参数错误",
            Data:  nil,
        })
        return
    }

    data, err := h.Service.GetTaskStats(req)
    if err != nil {
        response.R(c, response.Response{
            Error: -1,
            Msg:   err.Error(),
            Data:  nil,
        })
        return
    }

    response.R(c, response.Response{
        Error: 0,
        Msg:   "成功",
        Data:  data,
    })
}
```

#### 步骤 4：注册路由

编辑 `internal/router/router.go`：

```go
func SetupRouter(r *gin.Engine) {
    api := r.Group("/api")
    hdl := handler.NewHandler()
    {
        // ... 现有路由
        api.GET("/stats/tasks", hdl.GetTaskStats) // 新增
    }
}
```

#### 步骤 5：测试接口

```powershell
# 启动服务
go run cmd/server/main.go

# 测试接口
curl "http://127.0.0.1:8888/api/stats/tasks?start_date=2024-01-01&end_date=2024-12-31"
```

### 场景 3：添加新的 TTS 服务

假设要添加一个名为 `newtts` 的新 TTS 服务。

#### 步骤 1：创建 TTS 包

创建 `pkg/newtts/tts.go`：

```go
package newtts

import (
    "krillin-ai/config"
)

type Client struct {
    apiKey string
}

func NewClient() *Client {
    return &Client{
        apiKey: config.Conf.Tts.NewTts.ApiKey,
    }
}

// 实现 Ttser 接口
func (c *Client) Text2Speech(text, voice string, outputFile string) error {
    // 实现 TTS 逻辑
    // 1. 调用 TTS API
    // 2. 下载音频文件
    // 3. 保存到 outputFile
    return nil
}
```

#### 步骤 2：更新配置

编辑 `config/config.go`：

```go
type NewTtsConfig struct {
    ApiKey string `toml:"api_key"`
}

type Tts struct {
    Provider string                 `toml:"provider"`
    Openai   OpenaiCompatibleConfig `toml:"openai"`
    Aliyun   AliyunTtsConfig        `toml:"aliyun"`
    NewTts   NewTtsConfig           `toml:"newtts"` // 新增
}
```

#### 步骤 3：集成到服务

编辑 `internal/service/init.go`：

```go
// 初始化 TTS 服务
switch config.Conf.Tts.Provider {
case "openai":
    svc.Ttser = openai.NewClient()
case "aliyun":
    svc.Ttser = aliyun.NewTtsClient()
case "newtts":
    svc.Ttser = newtts.NewClient() // 新增
}
```

### 场景 4：修改前端 UI

前端文件位于 `static/` 目录。

#### 步骤 1：修改 HTML

编辑 `static/index.html`：

```html
<!-- 添加新的 UI 元素 -->
<div class="new-feature">
    <button id="newButton">新功能</button>
</div>
```

#### 步骤 2：添加 JavaScript

在 `static/index.html` 的 `<script>` 标签中添加：

```javascript
document.getElementById('newButton').addEventListener('click', async () => {
    const response = await fetch('/api/new-endpoint');
    const data = await response.json();
    console.log(data);
});
```

#### 步骤 3：重新编译（如果使用 embed）

由于静态文件是通过 Go embed 嵌入的，修改后需要重新编译：

```powershell
go build -o krillinai.exe cmd/server/main.go
```

### 场景 5：添加自定义中间件

假设要添加一个请求日志中间件。

#### 步骤 1：创建中间件

编辑 `internal/handler/middleware.go`：

```go
func RequestLogger() gin.HandlerFunc {
    return func(c *gin.Context) {
        start := time.Now()
        path := c.Request.URL.Path
        
        // 处理请求
        c.Next()
        
        // 记录日志
        duration := time.Since(start)
        log.GetLogger().Info("请求处理完成",
            zap.String("path", path),
            zap.String("method", c.Request.Method),
            zap.Int("status", c.Writer.Status()),
            zap.Duration("duration", duration),
        )
    }
}
```

#### 步骤 2：注册中间件

编辑 `internal/router/router.go`：

```go
func SetupRouter(r *gin.Engine) {
    // 全局中间件
    r.Use(handler.RequestLogger())
    
    api := r.Group("/api")
    // ... 路由定义
}
```

## 开发规范

### 代码风格

1. **命名规范**
   - 包名：小写，简短，有意义
   - 文件名：小写，下划线分隔
   - 变量名：驼峰命名
   - 常量名：大写，下划线分隔

2. **注释规范**
   ```go
   // FunctionName 函数功能描述
   // 参数说明
   // 返回值说明
   func FunctionName(param string) error {
       // 实现
   }
   ```

3. **错误处理**
   ```go
   // 推荐：明确的错误处理
   if err != nil {
       log.GetLogger().Error("操作失败", zap.Error(err))
       return nil, fmt.Errorf("操作失败: %w", err)
   }
   
   // 不推荐：忽略错误
   result, _ := someFunction()
   ```

### 项目规范

1. **不要提交的文件**
   - `.vscode/`、`.idea/` 等 IDE 配置
   - `config/config.toml`（提交 `config-example.toml`）
   - `tasks/` 目录（任务临时文件）
   - 编译后的二进制文件

2. **Git 提交规范**
   ```
   feat: 添加新功能
   fix: 修复 bug
   docs: 文档更新
   style: 代码格式调整
   refactor: 代码重构
   test: 测试相关
   chore: 构建/工具链相关
   ```

3. **分支管理**
   - `master` - 主分支，稳定版本
   - `develop` - 开发分支
   - `feature/xxx` - 功能分支
   - `fix/xxx` - 修复分支

### 测试规范

1. **单元测试**
   ```go
   // 测试文件命名：xxx_test.go
   func TestFunctionName(t *testing.T) {
       result := FunctionName("input")
       if result != expected {
           t.Errorf("期望 %v, 得到 %v", expected, result)
       }
   }
   ```

2. **运行测试**
   ```powershell
   # 运行所有测试
   go test ./...
   
   # 运行特定包的测试
   go test ./internal/service
   
   # 查看测试覆盖率
   go test -cover ./...
   ```

## 调试技巧

### 1. 使用日志

项目使用 Zap 日志库：

```go
import (
    "krillin-ai/log"
    "go.uber.org/zap"
)

// 不同级别的日志
log.GetLogger().Debug("调试信息", zap.Any("data", data))
log.GetLogger().Info("普通信息", zap.String("key", "value"))
log.GetLogger().Warn("警告信息", zap.Error(err))
log.GetLogger().Error("错误信息", zap.Error(err))
```

### 2. 使用 Delve 调试器

```powershell
# 安装 Delve
go install github.com/go-delve/delve/cmd/dlv@latest

# 调试服务器版
dlv debug cmd/server/main.go

# 在代码中设置断点
(dlv) break main.main
(dlv) continue
```

### 3. 使用 GoLand 调试

1. 打开 `cmd/server/main.go`
2. 点击行号左侧设置断点
3. 点击右上角的调试按钮
4. 查看变量、调用栈等信息

### 4. 查看 HTTP 请求

使用 Postman 或 curl 测试 API：

```powershell
# GET 请求
curl "http://127.0.0.1:8888/api/capability/subtitleTask?task_id=xxx"

# POST 请求
curl -X POST "http://127.0.0.1:8888/api/capability/subtitleTask" `
  -H "Content-Type: application/json" `
  -d '{\"url\":\"https://example.com/video.mp4\"}'
```

### 5. 性能分析

```go
import _ "net/http/pprof"

// 在 main 函数中启动 pprof
go func() {
    http.ListenAndServe("localhost:6060", nil)
}()
```

访问 `http://localhost:6060/debug/pprof/` 查看性能数据。

## 常见问题

### Q1: 如何添加新的配置项？

1. 在 `config/config.go` 中添加字段
2. 在 `config/config-example.toml` 中添加示例
3. 在 `validateConfig()` 中添加验证逻辑
4. 在代码中使用 `config.Conf.YourField` 访问

### Q2: 如何处理跨平台兼容性？

使用 Go 的构建标签：

```go
// +build windows

package mypackage

// Windows 特定代码
```

```go
// +build darwin

package mypackage

// macOS 特定代码
```

### Q3: 如何优化性能？

1. 使用 goroutine 并发处理
2. 使用 sync.Pool 复用对象
3. 避免不必要的内存分配
4. 使用 pprof 分析性能瓶颈

### Q4: 如何处理大文件上传？

```go
// 设置最大上传大小
router.MaxMultipartMemory = 100 << 20 // 100 MB

// 流式处理文件
file, err := c.FormFile("file")
src, err := file.Open()
defer src.Close()

dst, err := os.Create(filepath)
defer dst.Close()

io.Copy(dst, src)
```

### Q5: 如何实现热重载？

使用 Air 工具：

```powershell
# 安装 Air
go install github.com/cosmtrek/air@latest

# 运行
air
```

创建 `.air.toml` 配置文件：

```toml
root = "."
tmp_dir = "tmp"

[build]
cmd = "go build -o ./tmp/main.exe ./cmd/server"
bin = "tmp/main.exe"
include_ext = ["go", "toml"]
exclude_dir = ["tmp", "vendor"]
```

## 进阶主题

### 1. 添加数据库支持

如果需要持久化存储，可以集成数据库：

```go
import (
    "gorm.io/driver/sqlite"
    "gorm.io/gorm"
)

db, err := gorm.Open(sqlite.Open("krillin.db"), &gorm.Config{})
```

### 2. 添加缓存层

使用 Redis 或内存缓存：

```go
import "github.com/patrickmn/go-cache"

c := cache.New(5*time.Minute, 10*time.Minute)
c.Set("key", "value", cache.DefaultExpiration)
```

### 3. 添加消息队列

处理异步任务：

```go
import "github.com/hibiken/asynq"

client := asynq.NewClient(asynq.RedisClientOpt{Addr: "localhost:6379"})
task := asynq.NewTask("subtitle:process", payload)
client.Enqueue(task)
```

### 4. 容器化部署

参考 `Dockerfile` 和 `docs/zh/docker.md`。

## 相关资源

- [Go 官方文档](https://golang.org/doc/)
- [Gin 框架文档](https://gin-gonic.com/docs/)
- [Fyne GUI 文档](https://developer.fyne.io/)
- [项目 GitHub](https://github.com/KrillinAI/KrillinAI)
- [项目目录结构](./项目目录结构.md)

## 贡献代码

1. Fork 项目
2. 创建功能分支
3. 提交代码
4. 创建 Pull Request
5. 等待审核

欢迎贡献代码！如有问题，请加入 QQ 群：754069680

