# è§†é¢‘ç¿»è¯‘ä»£ç æ‰§è¡Œæµç¨‹

> ç”¨æˆ·ç‚¹å‡»"å¼€å§‹ç¿»è¯‘"æŒ‰é’®åçš„å®Œæ•´ä»£ç æ‰§è¡Œè·¯å¾„

## ğŸ“‹ ç›®å½•

1. [å‰ç«¯äº¤äº’æµç¨‹](#å‰ç«¯äº¤äº’æµç¨‹)
2. [åç«¯APIå¤„ç†](#åç«¯apiå¤„ç†)
3. [æ ¸å¿ƒä¸šåŠ¡æµç¨‹](#æ ¸å¿ƒä¸šåŠ¡æµç¨‹)
4. [è¯¦ç»†æ‰§è¡Œæ­¥éª¤](#è¯¦ç»†æ‰§è¡Œæ­¥éª¤)
5. [å…³é”®å‡½æ•°è¯´æ˜](#å…³é”®å‡½æ•°è¯´æ˜)

---

## ğŸ–±ï¸ å‰ç«¯äº¤äº’æµç¨‹

### 1. ç”¨æˆ·ç‚¹å‡»æŒ‰é’®

**æ–‡ä»¶ä½ç½®ï¼š** `static/index.html:886`

```html
<!-- æ‰§è¡ŒæŒ‰é’® -->
<button type="button" id="executeButton" class="btn-primary">
  å¼€å§‹ç¿»è¯‘ Start Translating
</button>
```

### 2. æŒ‰é’®ç‚¹å‡»äº‹ä»¶å¤„ç†

**æ–‡ä»¶ä½ç½®ï¼š** `static/index.html:2389`

```javascript
executeButton.addEventListener("click", async () => {
  console.log("å¼€å§‹ä»»åŠ¡æŒ‰é’®è¢«ç‚¹å‡»");
  
  // 1. æ›´æ–°çŠ¶æ€æ 
  statusBar.textContent = "æ­£åœ¨æ‰§è¡Œä»»åŠ¡... - " + getSimpleTime();
  
  // 2. éªŒè¯å‚æ•°
  if (bilingualToggle && !bilingualToggle.checked && 
      embedSubtitleVideoTypeToggle && embedSubtitleVideoTypeToggle.checked) {
    alert("åˆæˆå­—å¹•åµŒå…¥è§†é¢‘å¿…é¡»æ‰“å¼€åŒè¯­é€‰é¡¹");
    return;
  }
  
  // 3. æ£€æŸ¥è§†é¢‘URL
  const inputType = document.querySelector('input[name="inputType"]:checked');
  if (!inputType) {
    alert("è¯·é€‰æ‹©è¾“å…¥æ–¹å¼");
    return;
  }
  
  // 4. æ”¶é›†è¡¨å•å‚æ•°
  const params = getParams();
  
  // 5. è°ƒç”¨å¯åŠ¨ä»»åŠ¡API
  const taskId = await startTask({ ...params, url });
  
  // 6. å¼€å§‹è½®è¯¢ä»»åŠ¡è¿›åº¦
  if (taskId) {
    executeButton.disabled = true;
    progressSection.classList.remove("hidden");
    await pollTaskProgress(taskId);
  }
});
```

### 3. æ”¶é›†è¡¨å•å‚æ•°

**æ–‡ä»¶ä½ç½®ï¼š** `static/index.html:2042`

```javascript
function getParams() {
  return {
    language: "zh_cn",
    origin_lang: document.getElementById("source-language").value,
    target_lang: translationToggle.checked ? translationLanguage.value : "none",
    bilingual: bilingualToggle.checked ? 1 : 2,
    translation_subtitle_pos: bilingualPosition.value === "top" ? 1 : 2,
    tts: voiceoverToggle.checked ? 1 : 2,
    modal_filter: document.getElementById("filler-filter-toggle").checked ? 1 : 2,
    embed_subtitle_video_type: embedSubtitleVideoTypeToggle.checked ? 
      embedSubtitle.value : "none",
    // ... æ›´å¤šå‚æ•°
  };
}
```

### 4. è°ƒç”¨å¯åŠ¨ä»»åŠ¡API

**æ–‡ä»¶ä½ç½®ï¼š** `static/index.html:2209`

```javascript
async function startTask(params) {
  const response = await fetch(API_SUBMIT_URL, {  // "/api/capability/subtitleTask"
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(params),
  });
  
  const data = await response.json();
  if (+data.error !== 0 && +data.error !== 200) {
    throw new Error(data.msg || "å¯åŠ¨ä»»åŠ¡å¤±è´¥");
  }
  
  return data.data.task_id;
}
```

### 5. è½®è¯¢ä»»åŠ¡è¿›åº¦

**æ–‡ä»¶ä½ç½®ï¼š** `static/index.html:2229`

```javascript
async function pollTaskProgress(taskId) {
  const interval = setInterval(async () => {
    const response = await fetch(`/api/capability/subtitleTask?taskId=${taskId}`);
    const data = await response.json();
    
    // æ›´æ–°è¿›åº¦æ¡
    progressBar.value = data.data.process_percent;
    
    // æ£€æŸ¥ä»»åŠ¡çŠ¶æ€
    if (data.data.status === 2) {  // å®Œæˆ
      clearInterval(interval);
      showDownloadLinks(taskId);
    } else if (data.data.status === 3) {  // å¤±è´¥
      clearInterval(interval);
      alert("ä»»åŠ¡å¤±è´¥: " + data.msg);
    }
  }, 5000);  // æ¯5ç§’è½®è¯¢ä¸€æ¬¡
}
```

---

## ğŸ”Œ åç«¯APIå¤„ç†

### 1. è·¯ç”±æ³¨å†Œ

**æ–‡ä»¶ä½ç½®ï¼š** `internal/server/server.go`

```go
func StartBackend() error {
    r := gin.Default()
    
    // æ³¨å†Œè·¯ç”±
    r.POST("/api/capability/subtitleTask", handler.StartSubtitleTask)
    r.GET("/api/capability/subtitleTask", handler.GetSubtitleTask)
    
    // å¯åŠ¨æœåŠ¡å™¨
    r.Run(fmt.Sprintf("%s:%d", config.Conf.Server.Host, config.Conf.Server.Port))
}
```

### 2. Handlerå±‚ï¼šæ¥æ”¶è¯·æ±‚

**æ–‡ä»¶ä½ç½®ï¼š** `internal/handler/subtitle_task.go:16`

```go
func (h Handler) StartSubtitleTask(c *gin.Context) {
    // 1. è§£æè¯·æ±‚å‚æ•°
    var req dto.StartVideoSubtitleTaskReq
    if err := c.ShouldBindJSON(&req); err != nil {
        log.GetLogger().Error("StartSubtitleTask ShouldBindJSON err", zap.Error(err))
        response.R(c, response.Response{
            Error: -1,
            Msg:   "å‚æ•°é”™è¯¯",
        })
        return
    }
    
    // 2. æ£€æŸ¥é…ç½®æ˜¯å¦éœ€è¦é‡æ–°åˆå§‹åŒ–
    if configUpdated {
        log.GetLogger().Info("æ£€æµ‹åˆ°é…ç½®æ›´æ–°ï¼Œé‡æ–°åˆå§‹åŒ–æœåŠ¡")
        deps.CheckDependency()
        h.Service = service.NewService()
        configUpdated = false
    }
    
    // 3. è°ƒç”¨Serviceå±‚å¤„ç†ä¸šåŠ¡é€»è¾‘
    data, err := h.Service.StartSubtitleTask(req)
    if err != nil {
        response.R(c, response.Response{
            Error: -1,
            Msg:   err.Error(),
        })
        return
    }
    
    // 4. è¿”å›æˆåŠŸå“åº”
    response.R(c, response.Response{
        Error: 0,
        Msg:   "æˆåŠŸ",
        Data:  data,  // åŒ…å« task_id
    })
}
```

---

## âš™ï¸ æ ¸å¿ƒä¸šåŠ¡æµç¨‹

### Serviceå±‚ï¼šä»»åŠ¡ç¼–æ’

**æ–‡ä»¶ä½ç½®ï¼š** `internal/service/subtitle_service.go:20`

```go
func (s Service) StartSubtitleTask(req dto.StartVideoSubtitleTaskReq) (*dto.StartVideoSubtitleTaskResData, error) {
    // 1. æ ¡éªŒé“¾æ¥
    if strings.Contains(req.Url, "youtube.com") {
        videoId, _ := util.GetYouTubeID(req.Url)
        if videoId == "" {
            return nil, fmt.Errorf("é“¾æ¥ä¸åˆæ³•")
        }
    }
    
    // 2. ç”Ÿæˆä»»åŠ¡ID
    taskId := fmt.Sprintf("%s_%s", 
        util.SanitizePathName(videoName), 
        util.GenerateRandStringWithUpperLowerNum(4))
    
    // 3. åˆ›å»ºä»»åŠ¡æ–‡ä»¶å¤¹
    taskBasePath := filepath.Join("./tasks", taskId)
    os.MkdirAll(filepath.Join(taskBasePath, "output"), os.ModePerm)
    
    // 4. åˆ›å»ºä»»åŠ¡å¯¹è±¡
    taskPtr := &types.SubtitleTask{
        TaskId:   taskId,
        VideoSrc: req.Url,
        Status:   types.SubtitleTaskStatusProcessing,
    }
    storage.SubtitleTasks.Store(taskId, taskPtr)
    
    // 5. æ„é€ ä»»åŠ¡å‚æ•°
    stepParam := types.SubtitleTaskStepParam{
        TaskId:                  taskId,
        TaskPtr:                 taskPtr,
        TaskBasePath:            taskBasePath,
        Link:                    req.Url,
        SubtitleResultType:      resultType,
        EnableModalFilter:       req.ModalFilter == types.SubtitleTaskModalFilterYes,
        EnableTts:               req.Tts == types.SubtitleTaskTtsYes,
        OriginLanguage:          types.StandardLanguageCode(req.OriginLanguage),
        TargetLanguage:          types.StandardLanguageCode(req.TargetLang),
        EmbedSubtitleVideoType:  req.EmbedSubtitleVideoType,
        // ... æ›´å¤šå‚æ•°
    }
    
    // 6. å¯åŠ¨å¼‚æ­¥ä»»åŠ¡
    go func() {
        defer func() {
            if r := recover(); r != nil {
                log.GetLogger().Error("autoVideoSubtitle panic", zap.Any("panic:", r))
                stepParam.TaskPtr.Status = types.SubtitleTaskStatusFailed
            }
        }()
        
        // æ‰§è¡Œå®Œæ•´æµç¨‹
        s.linkToFile(ctx, &stepParam)        // ä¸‹è½½/æå–éŸ³é¢‘
        s.audioToSubtitle(ctx, &stepParam)   // éŸ³é¢‘è½¬å­—å¹•
        s.srtFileToSpeech(ctx, &stepParam)   // å­—å¹•è½¬è¯­éŸ³
        s.embedSubtitles(ctx, &stepParam)    // åµŒå…¥å­—å¹•
        s.uploadSubtitles(ctx, &stepParam)   // ä¸Šä¼ ç»“æœ
    }()
    
    // 7. ç«‹å³è¿”å›ä»»åŠ¡ID
    return &dto.StartVideoSubtitleTaskResData{
        TaskId: taskId,
    }, nil
}
```

---

## ğŸ“ è¯¦ç»†æ‰§è¡Œæ­¥éª¤

### æ­¥éª¤1ï¼šé“¾æ¥è½¬æ–‡ä»¶ (linkToFile)

**æ–‡ä»¶ä½ç½®ï¼š** `internal/service/link2file.go:18`

**æ—¥å¿—æ—¶é—´ï¼š** 10:37:53 - 10:38:19 (çº¦26ç§’)

```go
func (s Service) linkToFile(ctx context.Context, stepParam *types.SubtitleTaskStepParam) error {
    link := stepParam.Link
    audioPath := fmt.Sprintf("%s/%s", stepParam.TaskBasePath, types.SubtitleTaskAudioFileName)
    videoPath := fmt.Sprintf("%s/%s", stepParam.TaskBasePath, types.SubtitleTaskVideoFileName)
    
    stepParam.TaskPtr.ProcessPct = 3  // æ›´æ–°è¿›åº¦ï¼š3%
    
    if strings.Contains(link, "local:") {
        // æœ¬åœ°æ–‡ä»¶ï¼šä½¿ç”¨ffmpegæå–éŸ³é¢‘
        videoPath = strings.ReplaceAll(link, "local:", "")
        cmd := exec.Command(storage.FfmpegPath, 
            "-i", videoPath,           // è¾“å…¥è§†é¢‘
            "-vn",                     // ä¸å¤„ç†è§†é¢‘æµ
            "-ar", "44100",            // é‡‡æ ·ç‡
            "-ac", "2",                // å£°é“æ•°
            "-ab", "192k",             // æ¯”ç‰¹ç‡
            "-f", "mp3",               // è¾“å‡ºæ ¼å¼
            audioPath)                 // è¾“å‡ºæ–‡ä»¶
        output, err := cmd.CombinedOutput()
        
    } else if strings.Contains(link, "youtube.com") {
        // YouTubeï¼šä½¿ç”¨yt-dlpä¸‹è½½éŸ³é¢‘
        cmdArgs := []string{
            "-f", "bestaudio[ext=m4a]/bestaudio[ext=mp3]/bestaudio/worst",
            "--extract-audio",
            "--audio-format", "mp3",
            "--audio-quality", "192K",
            "-o", audioPath,
            stepParam.Link,
        }
        cmd := exec.Command(storage.YtdlpPath, cmdArgs...)
        output, err := cmd.CombinedOutput()
        
    } else if strings.Contains(link, "bilibili.com") {
        // Bç«™ï¼šä½¿ç”¨yt-dlpä¸‹è½½éŸ³é¢‘
        cmdArgs := []string{
            "-f", "bestaudio[ext=m4a]",
            "-x",
            "--audio-format", "mp3",
            "-o", audioPath,
            stepParam.Link,
        }
        cmd := exec.Command(storage.YtdlpPath, cmdArgs...)
        output, err := cmd.CombinedOutput()
    }
    
    stepParam.TaskPtr.ProcessPct = 6  // æ›´æ–°è¿›åº¦ï¼š6%
    stepParam.AudioFilePath = audioPath
    
    // å¦‚æœéœ€è¦åµŒå…¥å­—å¹•ï¼Œä¸‹è½½åŸè§†é¢‘
    if !strings.HasPrefix(link, "local:") && stepParam.EmbedSubtitleVideoType != "none" {
        cmdArgs := []string{
            "-f", "bestvideo[height<=1080][ext=mp4]+bestaudio[ext=m4a]",
            "-o", videoPath,
            stepParam.Link,
        }
        cmd := exec.Command(storage.YtdlpPath, cmdArgs...)
        cmd.CombinedOutput()
    }
    
    stepParam.InputVideoPath = videoPath
    stepParam.TaskPtr.ProcessPct = 10  // æ›´æ–°è¿›åº¦ï¼š10%
    
    return nil
}
```

**æ—¥å¿—è¾“å‡ºï¼š**
```
2025-10-06T10:37:53.244+0800  info  service/subtitle_service.go:137  video subtitle start task
```

### æ­¥éª¤2ï¼šéŸ³é¢‘è½¬å­—å¹• (audioToSubtitle)

**æ–‡ä»¶ä½ç½®ï¼š** `internal/service/audio2subtitle.go:31`

**æ—¥å¿—æ—¶é—´ï¼š** 10:38:19 - 10:41:15 (çº¦3åˆ†é’Ÿ)

```go
func (s Service) audioToSubtitle(ctx context.Context, stepParam *types.SubtitleTaskStepParam) error {
    // 2.1 éŸ³é¢‘è½¬SRT
    err := s.audioToSrt(ctx, stepParam)
    if err != nil {
        return fmt.Errorf("audioToSubtitle audioToSrt error: %w", err)
    }
    
    // 2.2 åˆ†å‰²SRT
    err = splitSrt(stepParam)
    if err != nil {
        return fmt.Errorf("audioToSubtitle splitSrt error: %w", err)
    }
    
    stepParam.TaskPtr.ProcessPct = 95  // æ›´æ–°è¿›åº¦ï¼š95%
    return nil
}
```

#### 2.1 éŸ³é¢‘è½¬SRT (audioToSrt)

**æ–‡ä»¶ä½ç½®ï¼š** `internal/service/audio2subtitle.go:233`

```go
func (s Service) audioToSrt(ctx context.Context, stepParam *types.SubtitleTaskStepParam) error {
    log.GetLogger().Info("audioToSubtitle.audioToSrt start", zap.Any("taskId", stepParam.TaskId))
    
    // 2.1.1 è®¡ç®—éŸ³é¢‘åˆ†å‰²ç‚¹
    timePoints, err := GetSplitPoints(
        stepParam.AudioFilePath, 
        float64(config.Conf.App.SegmentDuration)*60)
    
    log.GetLogger().Info("audioToSubtitle audioToSrt GetSplitPoints completed", 
        zap.Any("timePoints", timePoints))
    // è¾“å‡º: [0, 298.7, 596.0, 903.1, 1204.0, 1499.6, 1796.8, 1926.6]
    
    stepParam.TaskPtr.ProcessPct = 15  // æ›´æ–°è¿›åº¦ï¼š15%
    
    segmentNum := len(timePoints) - 1  // 7ä¸ªåˆ†æ®µ
    
    // åˆ›å»ºå¤„ç†é˜Ÿåˆ—
    pendingSplitQueue := make(chan DataWithId[[2]float64], segmentNum)
    splitResultQueue := make(chan DataWithId[string], segmentNum)
    pendingTranscriptionQueue := make(chan DataWithId[string], segmentNum)
    transcribedQueue := make(chan DataWithId[*types.TranscriptionData], segmentNum)
    pendingTranslationQueue := make(chan DataWithId[string], segmentNum)
    translatedQueue := make(chan DataWithId[[]*TranslatedItem], segmentNum)
    
    eg, ctx := errgroup.WithContext(ctx)
    
    // 2.1.2 å¹¶å‘åˆ†å‰²éŸ³é¢‘
    for range runtime.NumCPU() {
        eg.Go(func() error {
            for splitItem := range pendingSplitQueue {
                log.GetLogger().Info("Begin split audio", 
                    zap.Any("splitId", splitItem.Id))
                
                outputFileName := filepath.Join(stepParam.TaskBasePath, 
                    fmt.Sprintf("split_%d.mp3", splitItem.Id))
                
                err := ClipAudio(stepParam.AudioFilePath, outputFileName, 
                    splitItem.Data[0], splitItem.Data[1])
                
                log.GetLogger().Info("Split audio completed", 
                    zap.Any("splitId", splitItem.Id))
                
                splitResultQueue <- DataWithId[string]{
                    Data: outputFileName,
                    Id:   splitItem.Id,
                }
            }
            return nil
        })
    }
    
    // 2.1.3 å¹¶å‘è¯­éŸ³è¯†åˆ«
    for range config.Conf.App.TranscribeParallelNum {  // é»˜è®¤2ä¸ªå¹¶å‘
        eg.Go(func() error {
            for audioFileItem := range pendingTranscriptionQueue {
                log.GetLogger().Info("Begin transcribe", 
                    zap.Any("splitId", audioFileItem.Id))
                
                // è°ƒç”¨OpenAI Whisper API
                transcriptionData, err := s.transcribeAudio(
                    audioFileItem.Id, 
                    audioFileItem.Data, 
                    string(stepParam.OriginLanguage), 
                    stepParam.TaskBasePath)
                
                log.GetLogger().Info("Transcribe completed", 
                    zap.Any("splitId", audioFileItem.Id))
                
                transcribedQueue <- DataWithId[*types.TranscriptionData]{
                    Data: transcriptionData,
                    Id:   audioFileItem.Id,
                }
            }
            return nil
        })
    }
    
    // 2.1.4 ç¿»è¯‘å¤„ç†
    eg.Go(func() error {
        for translateItem := range pendingTranslationQueue {
            log.GetLogger().Info("Begin to translate", 
                zap.Any("splitId", translateItem.Id))
            
            // åˆ†å¥+ç¿»è¯‘
            translatedResults, err := s.splitTextAndTranslateV2(
                stepParam.TaskBasePath, 
                translateItem.Data, 
                stepParam.OriginLanguage, 
                stepParam.TargetLanguage, 
                stepParam.EnableModalFilter, 
                translateItem.Id)
            
            log.GetLogger().Info("Translate completed", 
                zap.Any("splitId", translateItem.Id))
            
            // äºŒæ¬¡åˆ†å‰²é•¿å¥
            splitResults, err := s.splitTranslateItem(translatedResults)
            if err != nil {
                log.GetLogger().Error("audioToSubtitle audioToSrt splitTranslateItem err", 
                    zap.Error(err))
                // ä¸ä¸­æ–­ï¼Œä½¿ç”¨åŸç»“æœ
                translatedQueue <- DataWithId[[]*TranslatedItem]{
                    Data: translatedResults,
                    Id:   translateItem.Id,
                }
            } else {
                translatedQueue <- DataWithId[[]*TranslatedItem]{
                    Data: splitResults,
                    Id:   translateItem.Id,
                }
            }
        }
        return nil
    })
    
    // ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
    eg.Wait()
    
    stepParam.TaskPtr.ProcessPct = 90  // æ›´æ–°è¿›åº¦ï¼š90%
    
    log.GetLogger().Info("audioToSubtitle.audioToSrt end", 
        zap.Any("taskId", stepParam.TaskId))
    
    return nil
}
```

**æ—¥å¿—è¾“å‡ºï¼š**
```
2025-10-06T10:38:19.808+0800  info  service/audio2subtitle.go:241  audioToSubtitle.audioToSrt start
2025-10-06T10:38:20.396+0800  info  service/audio2subtitle.go:247  audioToSubtitle audioToSrt GetSplitPoints completed
  {"timePoints": [0, 298.709, 595.995, 903.051, 1203.958, 1499.556, 1796.777, 1926.583]}
2025-10-06T10:38:20.396+0800  info  service/audio2subtitle.go:303  Begin split audio  {"splitId": 0}
2025-10-06T10:38:22.000+0800  info  service/audio2subtitle.go:310  Split audio completed  {"splitId": 6}
2025-10-06T10:38:22.000+0800  info  service/audio2subtitle.go:337  Begin transcribe  {"splitId": 6}
2025-10-06T10:38:36.888+0800  info  service/audio2subtitle.go:348  Transcribe completed  {"splitId": 6}
2025-10-06T10:38:36.889+0800  info  service/audio2subtitle.go:373  Begin to translate  {"splitId": 6}
2025-10-06T10:38:59.415+0800  info  service/audio2subtitle.go:384  Translate completed  {"splitId": 6}
```

### æ­¥éª¤3ï¼šå­—å¹•è½¬è¯­éŸ³ (srtFileToSpeech)

**æ–‡ä»¶ä½ç½®ï¼š** `internal/service/srt2speech.go`

**æ—¥å¿—æ—¶é—´ï¼š** 10:41:15 (å¦‚æœå¯ç”¨TTS)

```go
func (s Service) srtFileToSpeech(ctx context.Context, stepParam *types.SubtitleTaskStepParam) error {
    if !stepParam.EnableTts {
        log.GetLogger().Info("srtFileToSpeech skip", zap.String("task id", stepParam.TaskId))
        return nil
    }
    
    // è¯»å–å­—å¹•æ–‡ä»¶
    srtFile := filepath.Join(stepParam.TaskBasePath, "target_language_srt.srt")
    subtitles, err := parseSRT(srtFile)
    
    // ä¸ºæ¯ä¸ªå­—å¹•ç”Ÿæˆè¯­éŸ³
    for i, subtitle := range subtitles {
        audioFile := filepath.Join(stepParam.TaskBasePath, fmt.Sprintf("tts_%d.wav", i))
        err := s.TtsClient.Text2Speech(subtitle.Text, stepParam.TtsVoiceCode, audioFile)
    }
    
    // åˆå¹¶æ‰€æœ‰è¯­éŸ³æ–‡ä»¶
    finalOutput := filepath.Join(stepParam.TaskBasePath, "tts_final.wav")
    err = concatenateAudioFiles(audioFiles, finalOutput, stepParam.TaskBasePath)
    
    // æ›¿æ¢è§†é¢‘ä¸­çš„éŸ³é¢‘
    videoWithTtsPath := filepath.Join(stepParam.TaskBasePath, "video_with_tts.mp4")
    err = util.ReplaceAudioInVideo(stepParam.InputVideoPath, finalOutput, videoWithTtsPath)
    
    stepParam.TaskPtr.ProcessPct = 98  // æ›´æ–°è¿›åº¦ï¼š98%
    return nil
}
```

### æ­¥éª¤4ï¼šåµŒå…¥å­—å¹• (embedSubtitles)

**æ–‡ä»¶ä½ç½®ï¼š** `internal/service/srt_embed.go:24`

**æ—¥å¿—æ—¶é—´ï¼š** 10:41:15 - 10:42:09 (çº¦54ç§’)

```go
func (s Service) embedSubtitles(ctx context.Context, stepParam *types.SubtitleTaskStepParam) error {
    if stepParam.EmbedSubtitleVideoType == "none" {
        log.GetLogger().Info("åˆæˆè§†é¢‘ï¼šä¸åˆæˆ")
        return nil
    }
    
    // è·å–è§†é¢‘åˆ†è¾¨ç‡
    width, height, err := getResolution(stepParam.InputVideoPath)
    
    // æ¨ªå±è§†é¢‘
    if stepParam.EmbedSubtitleVideoType == "horizontal" || stepParam.EmbedSubtitleVideoType == "all" {
        if width < height {
            log.GetLogger().Info("æ£€æµ‹åˆ°è¾“å…¥è§†é¢‘æ˜¯ç«–å±ï¼Œæ— æ³•åˆæˆæ¨ªå±è§†é¢‘ï¼Œè·³è¿‡")
            return nil
        }
        
        log.GetLogger().Info("åˆæˆè§†é¢‘ï¼šæ¨ªå±")
        err = embedSubtitles(stepParam, true, stepParam.EnableTts)
    }
    
    // ç«–å±è§†é¢‘
    if stepParam.EmbedSubtitleVideoType == "vertical" || stepParam.EmbedSubtitleVideoType == "all" {
        if width > height {
            // è½¬æ¢ä¸ºç«–å±
            transferredVerticalVideoPath := filepath.Join(stepParam.TaskBasePath, 
                "transferred_vertical.mp4")
            err = convertToVertical(stepParam.InputVideoPath, transferredVerticalVideoPath, 
                stepParam.VerticalVideoMajorTitle, stepParam.VerticalVideoMinorTitle)
            stepParam.InputVideoPath = transferredVerticalVideoPath
        }
        
        log.GetLogger().Info("åˆæˆè§†é¢‘ï¼šç«–å±")
        err = embedSubtitles(stepParam, false, stepParam.EnableTts)
    }
    
    log.GetLogger().Info("å­—å¹•åµŒå…¥è§†é¢‘æˆåŠŸ")
    return nil
}
```

**æ—¥å¿—è¾“å‡ºï¼š**
```
2025-10-06T10:41:15.480+0800  info  service/srt_embed.go:40  åˆæˆè§†é¢‘ï¼šæ¨ªå±
2025-10-06T10:42:09.851+0800  info  service/srt_embed.go:65  å­—å¹•åµŒå…¥è§†é¢‘æˆåŠŸ
```

### æ­¥éª¤5ï¼šä¸Šä¼ å­—å¹• (uploadSubtitles)

**æ–‡ä»¶ä½ç½®ï¼š** `internal/service/upload_subtitle.go`

```go
func (s Service) uploadSubtitles(ctx context.Context, stepParam *types.SubtitleTaskStepParam) error {
    // å°†ç”Ÿæˆçš„å­—å¹•æ–‡ä»¶ç§»åŠ¨åˆ°outputç›®å½•
    // æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸ºå®Œæˆ
    stepParam.TaskPtr.Status = types.SubtitleTaskStatusCompleted
    stepParam.TaskPtr.ProcessPct = 100
    
    log.GetLogger().Info("video subtitle task end", zap.String("taskId", stepParam.TaskId))
    return nil
}
```

**æ—¥å¿—è¾“å‡ºï¼š**
```
2025-10-06T10:42:09.851+0800  info  service/subtitle_service.go:182  video subtitle task end
```

---

## ğŸ”‘ å…³é”®å‡½æ•°è¯´æ˜

### 1. GetSplitPoints - è®¡ç®—éŸ³é¢‘åˆ†å‰²ç‚¹

**æ–‡ä»¶ä½ç½®ï¼š** `internal/service/split_audio.go:106`

**ä½œç”¨ï¼š** æ ¹æ®éŸ³é¢‘æ—¶é•¿å’Œé…ç½®çš„åˆ†æ®µæ—¶é•¿ï¼Œè®¡ç®—æœ€ä½³åˆ†å‰²ç‚¹ï¼ˆåœ¨é™éŸ³å¤„åˆ†å‰²ï¼‰

```go
func GetSplitPoints(input string, segmentDuration float64) ([]float64, error) {
    // è·å–éŸ³é¢‘æ€»æ—¶é•¿
    audioDuration, err := util.GetAudioDuration(input)
    
    // è®¡ç®—åˆ†æ®µæ•°é‡
    segmentNum := int(math.Ceil(audioDuration / segmentDuration))
    
    // åˆå§‹åŒ–åˆ†å‰²ç‚¹
    timePoints := make([]float64, segmentNum+1)
    for i := range segmentNum {
        timePoints[i] = float64(i) * segmentDuration
    }
    
    // å¹¶å‘æŸ¥æ‰¾æ¯ä¸ªåˆ†å‰²ç‚¹é™„è¿‘çš„æœ€å®‰é™æ—¶åˆ»
    eg := errgroup.Group{}
    for i := 1; i < segmentNum; i++ {
        eg.Go(func() error {
            start := timePoints[i] - TOLERANCE_DURATION  // å‰å8ç§’å®¹å·®
            end := timePoints[i] + TOLERANCE_DURATION
            timePoint, err := getQuietestTimePoint(input, start, end)
            timePoints[i] = timePoint
            return nil
        })
    }
    
    eg.Wait()
    timePoints[len(timePoints)-1] = audioDuration
    
    return timePoints, nil
}
```

### 2. transcribeAudio - è¯­éŸ³è¯†åˆ«

**æ–‡ä»¶ä½ç½®ï¼š** `internal/service/audio2subtitle.go:92`

```go
func (s Service) transcribeAudio(id int, audioFilePath string, language string, taskBasePath string) (*types.TranscriptionData, error) {
    // è°ƒç”¨è½¬å½•æœåŠ¡ï¼ˆOpenAI Whisperï¼‰
    transcriptionData, err := s.Transcriber.Transcription(
        audioFilePath, 
        language, 
        taskBasePath)
    
    return transcriptionData, err
}
```

### 3. splitTextAndTranslateV2 - åˆ†å¥å¹¶ç¿»è¯‘

**æ–‡ä»¶ä½ç½®ï¼š** `internal/service/audio2subtitle.go`

```go
func (s Service) splitTextAndTranslateV2(taskBasePath, text string, originLang, targetLang types.StandardLanguageCode, enableModalFilter bool, splitId int) ([]*TranslatedItem, error) {
    // 1. ä½¿ç”¨LLMåˆ†å‰²é•¿å¥
    sentences, err := s.splitOriginLongSentence(text, originLang)
    
    // 2. è¿‡æ»¤è¯­æ°”è¯ï¼ˆå¦‚æœå¯ç”¨ï¼‰
    if enableModalFilter {
        sentences = filterModalWords(sentences)
    }
    
    // 3. å¹¶å‘ç¿»è¯‘æ¯ä¸ªå¥å­
    results := make([]*TranslatedItem, len(sentences))
    eg := errgroup.Group{}
    
    for i, sentence := range sentences {
        eg.Go(func() error {
            translation, err := s.ChatCompleter.ChatCompletion(
                fmt.Sprintf("Translate to %s: %s", targetLang, sentence))
            results[i] = &TranslatedItem{
                OriginText:     sentence,
                TranslatedText: translation,
            }
            return nil
        })
    }
    
    eg.Wait()
    return results, nil
}
```

### 4. splitTranslateItem - äºŒæ¬¡åˆ†å‰²é•¿å¥

**æ–‡ä»¶ä½ç½®ï¼š** `internal/service/audio2subtitle.go:1256`

```go
func (s Service) splitTranslateItem(items []*TranslatedItem) ([]*TranslatedItem, error) {
    results := []*TranslatedItem{}
    
    for _, item := range items {
        // æ£€æŸ¥ç¿»è¯‘åçš„æ–‡æœ¬æ˜¯å¦è¿‡é•¿
        if len(item.TranslatedText) > config.Conf.App.MaxSentenceLength {
            log.GetLogger().Info("splitTranslateItem long sentence detected", 
                zap.String("text", item.TranslatedText))
            
            // ä½¿ç”¨LLMå†æ¬¡åˆ†å‰²
            splitResults, err := s.splitLongSentence(item)
            if err != nil {
                log.GetLogger().Error("splitTranslateItem splitLongSentence error", 
                    zap.Error(err))
                // å¤±è´¥æ—¶ä½¿ç”¨åŸå¥
                results = append(results, item)
            } else {
                results = append(results, splitResults...)
            }
        } else {
            results = append(results, item)
        }
    }
    
    return results, nil
}
```

---

## ğŸ“Š å®Œæ•´æµç¨‹å›¾

```
ç”¨æˆ·ç‚¹å‡»"å¼€å§‹ç¿»è¯‘"
    â†“
å‰ç«¯æ”¶é›†å‚æ•°
    â†“
POST /api/capability/subtitleTask
    â†“
Handler.StartSubtitleTask
    â†“
Service.StartSubtitleTask
    â”œâ”€ ç”Ÿæˆä»»åŠ¡ID
    â”œâ”€ åˆ›å»ºä»»åŠ¡å¯¹è±¡
    â””â”€ å¯åŠ¨å¼‚æ­¥Goroutine
        â†“
    linkToFile (10%)
        â”œâ”€ æœ¬åœ°æ–‡ä»¶ï¼šffmpegæå–éŸ³é¢‘
        â”œâ”€ YouTubeï¼šyt-dlpä¸‹è½½
        â””â”€ Bç«™ï¼šyt-dlpä¸‹è½½
        â†“
    audioToSubtitle (10% â†’ 95%)
        â”œâ”€ audioToSrt
        â”‚   â”œâ”€ GetSplitPoints (15%)
        â”‚   â”‚   â””â”€ è®¡ç®—7ä¸ªåˆ†å‰²ç‚¹
        â”‚   â”œâ”€ å¹¶å‘åˆ†å‰²éŸ³é¢‘ (15% â†’ 20%)
        â”‚   â”‚   â””â”€ ClipAudio Ã— 7
        â”‚   â”œâ”€ å¹¶å‘è¯­éŸ³è¯†åˆ« (20% â†’ 50%)
        â”‚   â”‚   â””â”€ Whisper API Ã— 7
        â”‚   â””â”€ å¹¶å‘ç¿»è¯‘ (50% â†’ 90%)
        â”‚       â”œâ”€ splitTextAndTranslateV2 Ã— 7
        â”‚       â””â”€ splitTranslateItem Ã— 7
        â””â”€ splitSrt (90% â†’ 95%)
        â†“
    srtFileToSpeech (95% â†’ 98%)
        â”œâ”€ ç”ŸæˆTTSéŸ³é¢‘
        â””â”€ æ›¿æ¢è§†é¢‘éŸ³è½¨
        â†“
    embedSubtitles (98% â†’ 99%)
        â”œâ”€ æ¨ªå±è§†é¢‘åˆæˆ
        â””â”€ ç«–å±è§†é¢‘åˆæˆ
        â†“
    uploadSubtitles (99% â†’ 100%)
        â””â”€ ç§»åŠ¨æ–‡ä»¶åˆ°outputç›®å½•
        â†“
    ä»»åŠ¡å®Œæˆ
```

---

## ğŸ¯ æ€»ç»“

### å…³é”®æŠ€æœ¯ç‚¹

1. **å¼‚æ­¥å¤„ç†** - ä½¿ç”¨Goroutineå¼‚æ­¥æ‰§è¡Œä»»åŠ¡ï¼Œç«‹å³è¿”å›ä»»åŠ¡ID
2. **å¹¶å‘ä¼˜åŒ–** - ä½¿ç”¨errgroupå¹¶å‘å¤„ç†éŸ³é¢‘åˆ†å‰²ã€è¯†åˆ«ã€ç¿»è¯‘
3. **è¿›åº¦æ›´æ–°** - é€šè¿‡`TaskPtr.ProcessPct`å®æ—¶æ›´æ–°ä»»åŠ¡è¿›åº¦
4. **é”™è¯¯æ¢å¤** - ä½¿ç”¨defer+recoveræ•è·panicï¼Œé˜²æ­¢ä»»åŠ¡å´©æºƒ
5. **é‡è¯•æœºåˆ¶** - å…³é”®æ­¥éª¤ï¼ˆè¯†åˆ«ã€ç¿»è¯‘ï¼‰æ”¯æŒå¤šæ¬¡é‡è¯•
6. **é™çº§ç­–ç•¥** - é•¿å¥åˆ†å‰²å¤±è´¥æ—¶ä½¿ç”¨åŸå¥ï¼Œä¸ä¸­æ–­æµç¨‹

### æ€§èƒ½æ•°æ®ï¼ˆåŸºäºæ—¥å¿—ï¼‰

| é˜¶æ®µ | è€—æ—¶ | å æ¯” |
|------|------|------|
| éŸ³é¢‘æå– | ~26ç§’ | 9.6% |
| éŸ³é¢‘åˆ†å‰² | ~3.5ç§’ | 1.3% |
| è¯­éŸ³è¯†åˆ« | ~2åˆ†5ç§’ | 46.5% |
| ç¿»è¯‘å¤„ç† | ~2åˆ†39ç§’ | 59.1% |
| è§†é¢‘åˆæˆ | ~54ç§’ | 20.1% |
| **æ€»è®¡** | **~4åˆ†30ç§’** | **100%** |

### ä¼˜åŒ–å»ºè®®

1. **ç¼“å­˜æœºåˆ¶** - ç¼“å­˜LLMç¿»è¯‘ç»“æœï¼Œé¿å…é‡å¤è°ƒç”¨
2. **æ‰¹é‡å¤„ç†** - åˆå¹¶å¤šä¸ªçŸ­å¥ä¸€èµ·ç¿»è¯‘ï¼Œå‡å°‘APIè°ƒç”¨æ¬¡æ•°
3. **é¢„å¤„ç†** - æå‰æ£€æµ‹è§†é¢‘æ—¶é•¿ï¼ŒåŠ¨æ€è°ƒæ•´åˆ†æ®µç­–ç•¥
4. **å¹¶å‘æ§åˆ¶** - æ ¹æ®APIé™æµåŠ¨æ€è°ƒæ•´å¹¶å‘æ•°

