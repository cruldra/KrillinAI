# KrillinAI 前端界面说明

## 概述

KrillinAI 项目提供了两套完整的前端界面，分别适用于不同的使用场景：

1. **Web 界面** - 基于 HTML/JavaScript 的浏览器界面
2. **桌面界面** - 基于 Fyne 框架的原生桌面应用

两套界面功能基本一致，都提供了完整的视频翻译配音工作流程，但在部署方式、用户体验和适用场景上有所不同。

---

## 一、Web 界面 (index.html)

### 1.1 技术栈

- **纯前端实现**：HTML5 + CSS3 + Vanilla JavaScript
- **无框架依赖**：不依赖任何前端框架，轻量级实现
- **响应式设计**：支持不同屏幕尺寸
- **嵌入式部署**：通过 Go embed 打包到可执行文件中

### 1.2 文件位置

```
static/
├── index.html          # 主界面文件（约2500行）
├── background.jpg      # 背景图片
├── embed.go           # Go embed 配置文件
└── source/            # 图标资源
    ├── qwen-color.svg
    ├── openai.svg
    ├── deepseek-color.svg
    └── ...
```

### 1.3 界面结构

#### 主要布局
```
┌─────────────────────────────────────────┐
│  侧边栏 (Sidebar)                        │
│  ├── Logo: KrillinAI                    │
│  ├── Slogan                             │
│  ├── 导航按钮                            │
│  │   ├── 工作台 Dashboard               │
│  │   ├── LLM 配置 LLM Config            │
│  │   └── 设置 Settings                  │
│  └── 版本信息                            │
├─────────────────────────────────────────┤
│  主内容区 (Main Content)                 │
│  ├── 页面标题                            │
│  ├── 功能卡片                            │
│  └── 操作按钮                            │
├─────────────────────────────────────────┤
│  状态栏 (Status Bar)                     │
└─────────────────────────────────────────┘
```

#### 三个主要页面

**1. 工作台页面 (page-workbench)**
- 视频输入方式选择（URL下载 / 本地上传）
- 字幕设置
  - 源语言选择
  - 目标语言选择
  - 双语字幕开关
  - 翻译字幕位置（上/下）
  - 语气词过滤
- 配音设置
  - 配音开关
  - 音色选择
  - 声音克隆（上传音频文件）
- 视频合成设置
  - 字幕嵌入视频类型（无/横屏/竖屏）
  - 竖屏视频标题设置
- 执行按钮和进度显示
- 下载链接区域

**2. LLM 配置页面 (llm-config)**
- 供应商快速选择卡片
  - 通义千问 (Qwen)
  - OpenAI
  - DeepSeek
  - 自定义
- LLM 配置表单
  - Base URL
  - API Key
  - 模型名称（带建议下拉）
  - 代理设置

**3. 设置页面 (page-config)**
- 应用配置
  - 字幕分段处理时长
- 服务器配置
  - 端口设置
- 语音识别配置
  - 服务提供商选择
  - 各提供商的详细配置
- TTS 配置
  - 服务提供商选择
  - 各提供商的详细配置

### 1.4 核心功能

#### 配置管理
```javascript
// 加载配置
async function loadConfig() {
    const response = await fetch("/api/config", {
        method: "GET",
        headers: { "Content-Type": "application/json" }
    });
    // 填充表单...
}

// 保存配置
function saveConfig(showSuccessAlert = true, isAutoSave = false) {
    const configData = collectConfigData();
    return fetch("/api/config", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(configData)
    });
}
```

#### 任务执行
```javascript
// 启动任务
async function startTask(params) {
    const response = await fetch("/api/capability/subtitleTask", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(params)
    });
    // 返回任务ID
}

// 轮询任务进度
async function pollTaskProgress(taskId) {
    const response = await fetch(`/api/capability/subtitleTask?task_id=${taskId}`);
    // 更新进度条和状态
}
```

#### 文件上传
```javascript
async function uploadFile(file) {
    const formData = new FormData();
    formData.append("file", file);
    const response = await fetch("/api/file", {
        method: "POST",
        body: formData
    });
}
```

### 1.5 设计特点

- **渐变背景**：`linear-gradient(120deg, #f8fafc 0%, #e0e7ef 100%)`
- **毛玻璃效果**：卡片使用半透明背景和模糊效果
- **现代化按钮**：渐变色按钮带阴影和悬停动画
- **响应式布局**：支持 1200px 以下屏幕的适配
- **双语界面**：所有文本都提供中英文双语显示

### 1.6 API 路由

Web 界面通过以下 API 与后端通信：

```go
// internal/router/router.go
api.POST("/capability/subtitleTask", hdl.StartSubtitleTask)
api.GET("/capability/subtitleTask", hdl.GetSubtitleTask)
api.POST("/file", hdl.UploadFile)
api.GET("/file/*filepath", hdl.DownloadFile)
api.GET("/config", hdl.GetConfig)
api.POST("/config", hdl.UpdateConfig)

r.GET("/", func(c *gin.Context) {
    c.Redirect(http.StatusMovedPermanently, "/static")
})
r.StaticFS("/static", http.FS(static.EmbeddedFiles))
```

### 1.7 启动方式

**服务器模式（非桌面版）**

```bash
# 1. 配置 config/config.toml
# 2. 运行可执行文件
./KrillinAI_1.0.0_macOS_arm64

# 3. 浏览器访问
http://127.0.0.1:8888
```

入口文件：`cmd/server/main.go`

```go
func main() {
    log.InitLogger()
    config.LoadConfig()
    deps.CheckDependency()
    server.StartBackend()  // 启动 HTTP 服务器
}
```

---

## 二、桌面界面 (Fyne)

### 2.1 技术栈

- **框架**：[Fyne v2](https://fyne.io/) - Go 语言的跨平台 GUI 框架
- **语言**：Go
- **平台支持**：Windows、macOS、Linux
- **原生体验**：使用系统原生控件和主题

### 2.2 文件位置

```
internal/desktop/
├── desktop.go          # 主窗口和导航
├── ui.go              # 页面构建（配置、字幕任务）
├── components.go      # 可复用组件
├── theme.go           # 自定义主题定义
├── theme_manager.go   # 主题管理器
├── subtitle.go        # 字幕任务管理
└── file.go           # 文件管理
```

### 2.3 界面结构

#### 主窗口布局
```
┌─────────────────────────────────────────┐
│  侧边栏 (Sidebar)                        │
│  ├── Logo: KrillinAI                    │
│  ├── Slogan                             │
│  ├── 导航按钮                            │
│  │   ├── 工作台                          │
│  │   ├── LLM 配置                        │
│  │   ├── 设置                            │
│  │   └── 主题切换                        │
│  └── 版本信息                            │
├─────────────────────────────────────────┤
│  主内容区 (Tab Container)                │
│  └── 当前选中的页面内容                   │
├─────────────────────────────────────────┤
│  状态栏 (Status Bar)                     │
└─────────────────────────────────────────┘
```

#### 核心组件

**1. 主窗口 (desktop.go)**
```go
func Show() {
    myApp := app.New()
    myWindow := myApp.NewWindow("KrillinAI")
    
    // 创建主题管理器
    themeManager := NewThemeManager(myApp, myWindow)
    
    // 创建侧边栏
    sidebar := createSidebar(...)
    
    // 创建内容区
    mainContainer := container.NewBorder(nil, nil, sidebar, nil, content)
    
    myWindow.SetContent(finalContainer)
    myWindow.Resize(fyne.NewSize(1200, 800))
    myWindow.ShowAndRun()
}
```

**2. 页面构建 (ui.go)**

- `CreateSubtitleTab()` - 字幕任务页面
- `CreateLLMConfigTab()` - LLM 配置页面
- `CreateConfigTab()` - 应用设置页面

**3. 自定义组件 (components.go)**

```go
// 毛玻璃卡片
func GlassmorphismCard(title, subtitle string, content fyne.CanvasObject, isDark bool)

// 现代卡片
func ModernCard(title string, content fyne.CanvasObject, isDark bool)

// 透明卡片
func TransparentCard(content fyne.CanvasObject, isDark bool)

// 样式化输入框
func StyledEntry(placeholder string) *widget.Entry

// 样式化选择框
func StyledSelect(placeholder string, options []string) *widget.Select

// 标题文本
func TitleText(text string) *canvas.Text

// 副标题文本
func SubtitleText(text string) *canvas.Text
```

### 2.4 主题系统

#### 主题模式
```go
type ThemeMode int

const (
    ThemeModeLight ThemeMode = iota  // 明亮模式
    ThemeModeDark                     // 夜晚模式
    ThemeModeAuto                     // 自动模式
)
```

#### 主题管理器
```go
type ThemeManager struct {
    app        fyne.App
    window     fyne.Window
    theme      *customTheme
    isDarkMode bool
    callbacks  []func(bool)
}

// 切换主题
func (tm *ThemeManager) ToggleTheme()

// 添加主题变化回调
func (tm *ThemeManager) AddThemeChangeCallback(callback func(bool))
```

#### 配色方案

**明亮模式**
- 主色：`#3B82F6` (蓝色)
- 背景：`#F8FAFС` (极浅灰)
- 前景：`#111827` (深灰)
- 输入框：`#FFFFFF` (纯白)

**夜晚模式**
- 主色：`#60A5FA` (亮蓝)
- 背景：`#0F172A` (深蓝灰)
- 前景：`#F1F5F9` (浅灰)
- 输入框：`#1E293B` (深灰)

### 2.5 核心功能实现

#### 字幕任务管理 (subtitle.go)

```go
type SubtitleManager struct {
    window                fyne.Window
    videoUrl              string
    sourceLang            string
    targetLang            string
    bilingualEnabled      bool
    bilingualPosition     uint8
    voiceoverEnabled      bool
    ttsVoiceCode          string
    voiceoverAudioPath    string
    fillerFilter          bool
    embedSubtitle         uint8
    verticalTitles        []string
    taskId                string
    progressBar           *widget.ProgressBar
    downloadContainer     *fyne.Container
}

// 启动任务
func (sm *SubtitleManager) StartTask() error

// 轮询任务进度
func (sm *SubtitleManager) PollProgress() error

// 显示下载链接
func (sm *SubtitleManager) ShowDownloadLinks(files []string)
```

#### 文件管理 (file.go)

```go
type FileManager struct {
    window        fyne.Window
    files         []string
    selectedFiles []string
}

// 显示单文件上传对话框
func (fm *FileManager) ShowUploadDialog()

// 显示多文件上传对话框
func (fm *FileManager) ShowMultiUploadDialog()

// 上传文件到服务器
func (fm *FileManager) uploadFile(filePath, fileName string) error

// 下载文件
func (fm *FileManager) DownloadFile(index int)
```

#### 配置管理

桌面版直接操作 `config.Conf` 全局配置对象：

```go
// 读取配置
appSegmentDurationEntry.Bind(binding.IntToString(
    binding.BindInt(&config.Conf.App.SegmentDuration)
))

// 保存配置
err := config.SaveConfig()
```

### 2.6 与后端通信

桌面版通过 HTTP API 与后端服务通信（后端在 goroutine 中启动）：

```go
// cmd/desktop/main.go
func main() {
    log.InitLogger()
    config.LoadConfig()

    // 在 goroutine 中启动后端服务
    go func() {
        if err := server.StartBackend(); err != nil {
            log.GetLogger().Error("后端服务启动失败", zap.Error(err))
            os.Exit(1)
        }
    }()

    // 显示桌面界面
    desktop.Show()
}
```

API 调用示例：

```go
// 启动字幕任务
resp, err := http.Post(
    "http://localhost:8888/api/capability/subtitleTask",
    "application/json",
    bytes.NewBuffer(jsonData),
)

// 查询任务进度
resp, err := http.Get(
    fmt.Sprintf("http://localhost:8888/api/capability/subtitleTask?task_id=%s", taskId),
)

// 上传文件
resp, err := http.Post(
    "http://localhost:8888/api/file",
    writer.FormDataContentType(),
    body,
)
```

### 2.7 启动方式

**桌面模式**

```bash
# 直接运行可执行文件
./KrillinAI_1.0.0_desktop_macOS_arm64

# macOS 需要先授权
sudo xattr -cr ./KrillinAI_1.0.0_desktop_macOS_arm64
sudo chmod +x ./KrillinAI_1.0.0_desktop_macOS_arm64
./KrillinAI_1.0.0_desktop_macOS_arm64
```

入口文件：`cmd/desktop/main.go`

---

## 三、两套界面对比

### 3.1 功能对比

| 功能 | Web 界面 | 桌面界面 |
|------|---------|---------|
| 视频输入 | ✅ URL下载 / 本地上传 | ✅ URL下载 / 本地上传 |
| 字幕翻译 | ✅ | ✅ |
| 配音功能 | ✅ | ✅ |
| 声音克隆 | ✅ | ✅ |
| 视频合成 | ✅ | ✅ |
| LLM 配置 | ✅ | ✅ |
| 应用设置 | ✅ | ✅ |
| 主题切换 | ❌ | ✅ 明亮/夜晚模式 |
| 多文件上传 | ❌ | ✅ |
| 离线使用 | ❌ 需要浏览器 | ✅ 完全独立 |
| 配置持久化 | ✅ 服务器端 | ✅ 本地文件 |

### 3.2 技术对比

| 方面 | Web 界面 | 桌面界面 |
|------|---------|---------|
| 技术栈 | HTML/CSS/JavaScript | Go + Fyne |
| 依赖 | 浏览器 | 无（原生应用） |
| 打包方式 | embed.FS 嵌入 | 编译为可执行文件 |
| 跨平台 | ✅ 任何有浏览器的平台 | ✅ Windows/macOS/Linux |
| 性能 | 中等（浏览器渲染） | 高（原生渲染） |
| 内存占用 | 高（浏览器进程） | 低（单一进程） |
| 启动速度 | 快（浏览器已运行） | 中等（需启动应用） |
| 更新方式 | 刷新页面 | 重新下载安装 |

### 3.3 用户体验对比

| 方面 | Web 界面 | 桌面界面 |
|------|---------|---------|
| 界面风格 | 现代化 Web 设计 | 原生系统风格 |
| 响应速度 | 依赖网络延迟 | 本地即时响应 |
| 文件操作 | 受浏览器限制 | 原生文件对话框 |
| 系统集成 | 低 | 高（系统通知、托盘等） |
| 学习曲线 | 低（熟悉的 Web 界面） | 低（原生应用体验） |
| 多窗口支持 | ✅ 浏览器标签页 | ❌ 单窗口 |

### 3.4 适用场景

**Web 界面适合：**
- 服务器部署，多用户访问
- 不想安装额外软件的用户
- 需要远程访问的场景
- 团队协作使用
- Docker 容器化部署

**桌面界面适合：**
- 个人本地使用
- 需要更好性能的场景
- 离线环境使用
- 不熟悉命令行的用户
- 需要系统集成功能

---

## 四、共享后端架构

两套界面共享相同的后端服务：

### 4.1 后端服务启动

```go
// internal/server/server.go
func StartBackend() error {
    r := gin.Default()
    router.SetupRouter(r)

    port := config.Conf.Server.Port
    return r.Run(fmt.Sprintf(":%d", port))
}
```

### 4.2 API 处理器

```go
// internal/handler/handler.go
type Handler struct{}

func (h *Handler) StartSubtitleTask(c *gin.Context)
func (h *Handler) GetSubtitleTask(c *gin.Context)
func (h *Handler) UploadFile(c *gin.Context)
func (h *Handler) DownloadFile(c *gin.Context)
func (h *Handler) GetConfig(c *gin.Context)
func (h *Handler) UpdateConfig(c *gin.Context)
```

### 4.3 数据流程

```
┌─────────────┐
│  前端界面    │
│ (Web/Desktop)│
└──────┬──────┘
       │ HTTP API
       ↓
┌─────────────┐
│  Gin Router │
└──────┬──────┘
       │
       ↓
┌─────────────┐
│   Handler   │
└──────┬──────┘
       │
       ↓
┌─────────────┐
│   Service   │
│  (业务逻辑)  │
└──────┬──────┘
       │
       ↓
┌─────────────┐
│   Storage   │
│  (任务存储)  │
└─────────────┘
```

---

## 五、开发指南

### 5.1 修改 Web 界面

1. 编辑 `static/index.html`
2. 修改 HTML 结构、CSS 样式或 JavaScript 逻辑
3. 重新编译项目（Go embed 会自动打包）

```bash
go build -o KrillinAI cmd/server/main.go
```

### 5.2 修改桌面界面

1. 编辑 `internal/desktop/` 目录下的相关文件
   - `ui.go` - 页面布局
   - `components.go` - 组件样式
   - `theme.go` - 主题配色
   - `subtitle.go` - 业务逻辑

2. 重新编译项目

```bash
go build -o KrillinAI_desktop cmd/desktop/main.go
```

### 5.3 添加新功能

如果要在两套界面中都添加新功能：

1. **后端 API**：在 `internal/handler/` 添加新的处理器
2. **路由**：在 `internal/router/router.go` 注册路由
3. **Web 界面**：在 `static/index.html` 添加 UI 和 JavaScript 逻辑
4. **桌面界面**：在 `internal/desktop/ui.go` 添加对应的 Fyne 组件

### 5.4 调试技巧

**Web 界面调试：**
```bash
# 启动服务
./KrillinAI

# 浏览器打开开发者工具
# Chrome: F12 或 Cmd+Option+I (Mac)
# 查看 Console 和 Network 标签
```

**桌面界面调试：**
```bash
# 查看日志输出
./KrillinAI_desktop

# 日志文件位置
# Windows: app.log
# macOS/Linux: app.log
```

---

## 六、常见问题

### 6.1 Web 界面无法访问

**问题**：浏览器无法打开 `http://127.0.0.1:8888`

**解决方案**：
1. 检查服务是否启动成功
2. 检查端口是否被占用
3. 检查防火墙设置
4. 查看 `config.toml` 中的端口配置

### 6.2 桌面界面启动失败

**问题**：双击可执行文件无反应

**解决方案**：
1. macOS：执行授权命令（见 2.7 节）
2. Windows：右键"以管理员身份运行"
3. Linux：添加执行权限 `chmod +x KrillinAI_desktop`
4. 查看 `app.log` 日志文件

### 6.3 配置不生效

**问题**：修改配置后没有变化

**解决方案**：
- Web 界面：点击"保存配置"按钮
- 桌面界面：配置会自动保存，重启应用生效
- 检查 `config/config.toml` 文件权限

### 6.4 文件上传失败

**问题**：上传视频或音频文件失败

**解决方案**：
1. 检查文件大小限制
2. 检查 `uploads/` 目录权限
3. 检查磁盘空间
4. 查看浏览器控制台或应用日志

---

## 七、总结

KrillinAI 提供的两套前端界面各有优势：

- **Web 界面**：适合服务器部署和多用户场景，无需安装，访问便捷
- **桌面界面**：适合个人使用，性能更好，体验更原生

两套界面共享相同的后端服务和业务逻辑，确保功能一致性。开发者可以根据需求选择修改或扩展任一界面，也可以同时维护两套界面以满足不同用户群体的需求。

---

## 附录

### A. 相关文件清单

**Web 界面相关：**
- `static/index.html` - 主界面
- `static/embed.go` - 嵌入配置
- `static/source/` - 图标资源
- `internal/router/router.go` - 路由配置

**桌面界面相关：**
- `cmd/desktop/main.go` - 入口文件
- `internal/desktop/desktop.go` - 主窗口
- `internal/desktop/ui.go` - 页面构建
- `internal/desktop/components.go` - 组件库
- `internal/desktop/theme.go` - 主题定义
- `internal/desktop/theme_manager.go` - 主题管理
- `internal/desktop/subtitle.go` - 任务管理
- `internal/desktop/file.go` - 文件管理

**共享后端：**
- `cmd/server/main.go` - 服务器入口
- `internal/server/server.go` - 服务器启动
- `internal/handler/` - API 处理器
- `internal/router/router.go` - 路由配置
- `internal/service/` - 业务逻辑
- `internal/storage/` - 数据存储

### B. 参考资源

- [Fyne 官方文档](https://docs.fyne.io/)
- [Gin Web 框架](https://gin-gonic.com/)
- [Go embed 包文档](https://pkg.go.dev/embed)
- [项目 README](../../README.md)
- [二次开发指南](./二次开发指南.md)


